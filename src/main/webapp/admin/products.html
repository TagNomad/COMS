<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COMS - 产品管理</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div id="nav-placeholder"></div>

    <main class="main-content">
        <div id="header-placeholder"></div>

        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div class="form-group" style="margin-bottom: 0; width: 300px;">
                    <input type="text" class="form-control" placeholder="搜索产品..." id="searchInput"
                        oninput="searchProducts()">
                </div>
                <button class="btn btn-primary" onclick="openAddModal()">+ 新增产品</button>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>名称</th>
                            <th>分类</th>
                            <th>单位</th>
                            <th>价格</th>
                            <th>库存</th>
                            <th>状态</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="productList"></tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Modal -->
    <div class="modal-overlay" id="productModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">新增产品</h3>
                <button class="close-btn" onclick="hideModal('productModal')">&times;</button>
            </div>
            <form id="productForm" onsubmit="handleFormSubmit(event)">
                <input type="hidden" id="productId">
                <div class="form-group">
                    <label class="form-label">产品名称</label>
                    <input type="text" class="form-control" id="productName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">图片链接</label>
                    <input type="url" class="form-control" id="imageUrl" placeholder="https://example.com/image.jpg">
                </div>
                <div class="form-group">
                    <label class="form-label">分类</label>
                    <select class="form-control" id="categoryId" required></select>
                </div>
                <div class="form-group">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div>
                            <label class="form-label">价格</label>
                            <input type="number" step="0.01" class="form-control" id="price" required>
                        </div>
                        <div>
                            <label class="form-label">单位</label>
                            <input type="text" class="form-control" id="unit" required>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div>
                            <label class="form-label">库存</label>
                            <input type="number" class="form-control" id="stockQuantity" required>
                        </div>
                        <div>
                            <label class="form-label">状态</label>
                            <select class="form-control" id="status">
                                <option value="在售">在售</option>
                                <option value="下架">下架</option>
                                <option value="缺货">缺货</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">描述</label>
                    <textarea class="form-control" id="description" rows="3"></textarea>
                </div>
                <div style="text-align: right; margin-top: 20px;">
                    <button type="button" class="btn"
                        style="background: transparent; color: var(--text-muted); margin-right: 10px;"
                        onclick="hideModal('productModal')">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <script src="../assets/js/app.js"></script>
    <script>
        let categories = [];

        async function loadData() {
            categories = await fetchAPI('/category');
            const select = document.getElementById('categoryId');

            // Build hierarchical category options
            // First, get top-level categories (parent_id is null)
            const topLevel = categories.filter(c => c.parentId === null);
            const subCategories = categories.filter(c => c.parentId !== null);

            let options = '';
            topLevel.forEach(parent => {
                options += `<option value="${parent.categoryId}">${parent.categoryName}</option>`;
                // Find children of this parent
                const children = subCategories.filter(c => c.parentId === parent.categoryId);
                children.forEach(child => {
                    options += `<option value="${child.categoryId}">&nbsp;&nbsp;└ ${child.categoryName}</option>`;
                });
            });

            // Add any orphan sub-categories (parent doesn't exist)
            const orphans = subCategories.filter(c => !topLevel.some(p => p.categoryId === c.parentId));
            orphans.forEach(orphan => {
                options += `<option value="${orphan.categoryId}">${orphan.categoryName}</option>`;
            });

            select.innerHTML = options;

            await searchProducts();
        }

        async function searchProducts() {
            const keyword = document.getElementById('searchInput').value;
            const url = keyword ? `/product?keyword=${keyword}` : '/product';
            const products = await fetchAPI(url);
            renderTable(products);
        }

        function renderTable(products) {
            const tbody = document.getElementById('productList');
            tbody.innerHTML = products.map(p => `
                <tr>
                    <td>${p.productId}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            ${p.imageUrl ? `<img src="${p.imageUrl}" style="width: 40px; height: 40px; border-radius: 6px; object-fit: cover;" onerror="this.src='https://via.placeholder.com/40'">` : ''}
                            <span>${p.productName}</span>
                        </div>
                    </td>
                    <td>${p.categoryName || '-'}</td>
                    <td>${p.unit}</td>
                    <td>${formatCurrency(p.price)}</td>
                    <td>${p.stockQuantity}</td>
                    <td><span class="status-badge ${getStatusClass(p.status)}">${p.status}</span></td>
                    <td>
                        <button class="btn btn-primary" style="padding: 6px 12px; font-size: 13px" onclick='editProduct(${JSON.stringify(p)})'>编辑</button>
                        <button class="btn btn-danger" style="padding: 6px 12px; font-size: 13px; margin-left: 6px;" onclick="deleteProduct(${p.productId})">删除</button>
                    </td>
                </tr>
            `).join('');
        }

        function getStatusClass(status) {
            if (status === '在售') return 'status-in-stock';
            if (status === '缺货') return 'status-out-stock';
            return 'status-low-stock';
        }

        function openAddModal() {
            document.getElementById('modalTitle').textContent = '新增产品';
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = '';
            showModal('productModal');
        }

        function editProduct(p) {
            document.getElementById('modalTitle').textContent = '编辑产品';
            document.getElementById('productId').value = p.productId;
            document.getElementById('productName').value = p.productName;
            document.getElementById('imageUrl').value = p.imageUrl || '';
            document.getElementById('categoryId').value = p.categoryId;
            document.getElementById('price').value = p.price;
            document.getElementById('unit').value = p.unit;
            document.getElementById('stockQuantity').value = p.stockQuantity;
            document.getElementById('status').value = p.status;
            document.getElementById('description').value = p.description || '';
            showModal('productModal');
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('productId').value;
            const data = {
                productName: document.getElementById('productName').value,
                imageUrl: document.getElementById('imageUrl').value,
                categoryId: document.getElementById('categoryId').value,
                price: document.getElementById('price').value,
                unit: document.getElementById('unit').value,
                stockQuantity: document.getElementById('stockQuantity').value,
                status: document.getElementById('status').value,
                description: document.getElementById('description').value
            };

            if (id) {
                data.productId = id;
                await fetchAPI('/product', { method: 'PUT', body: JSON.stringify(data) });
            } else {
                await fetchAPI('/product', { method: 'POST', body: JSON.stringify(data) });
            }
            hideModal('productModal');
            loadData();
        }

        async function deleteProduct(id) {
            if (confirm('确定要删除该产品吗？')) {
                await fetchAPI(`/product/${id}`, { method: 'DELETE' });
                loadData();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadAdminComponents('产品管理');
            loadData();
        });
    </script>
</body>

</html>